<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fakecord | Global Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #36393f;
            --bg-card: #2f3136;
            --bg-input: #202225;
            --discord-blue: #5865f2;
            --text-main: #dcddde;
            --text-muted: #72767d;
            --danger: #f04747;
            --success: #43b581;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-dark); color: var(--text-main); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: var(--bg-card); padding: 32px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); width: 400px; }
        
        /* Tab Navigation */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #4f545c; }
        .tab { cursor: pointer; color: var(--text-muted); font-weight: bold; text-transform: uppercase; font-size: 0.8rem; padding-bottom: 10px; }
        .tab.active { color: #fff; border-bottom: 2px solid var(--discord-blue); }

        /* Form Controls */
        label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; }
        input { background: var(--bg-input); border: 1px solid var(--bg-input); color: white; padding: 12px; border-radius: 3px; width: 100%; box-sizing: border-box; margin-bottom: 15px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--discord-blue); }
        
        button { background: var(--discord-blue); color: white; border: none; padding: 12px; border-radius: 3px; cursor: pointer; font-weight: 500; width: 100%; font-size: 1rem; transition: background 0.2s; }
        button:hover { background: #4752c4; }

        /* Alerts */
        .error-box { color: var(--danger); background: rgba(240, 71, 71, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; border: 1px solid var(--danger); font-size: 0.85rem; }

        /* Chat Layout */
        #chat-container { display: none; width: 900px; height: 85vh; flex-direction: column; }
        #messages { flex-grow: 1; overflow-y: auto; background: var(--bg-dark); padding: 20px; margin-bottom: 15px; border-radius: 4px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .username { color: #fff; font-weight: 600; margin-right: 8px; }
        .timestamp { color: var(--text-muted); font-size: 0.75rem; }
        .msg-join { color: var(--success); font-style: italic; text-align: center; font-size: 0.85rem; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="auth-container" class="card">
        <div class="tabs">
            <span id="tab-login" class="tab active" onclick="switchMode('login')">Login</span>
            <span id="tab-reg" class="tab" onclick="switchMode('reg')">Register</span>
        </div>

        <div id="auth-error" class="error-box"></div>

        <div id="auth-form">
            <label>Login ID</label>
            <input type="text" id="input-login" placeholder="Your unique ID">
            
            <label>Password</label>
            <input type="password" id="input-password" placeholder="••••••••">

            <div id="reg-only" style="display: none;">
                <label>Confirm Password</label>
                <input type="password" id="input-confirm" placeholder="Repeat password">

                <label>Email Address</label>
                <input type="email" id="input-email" placeholder="mail@example.com">
                
                <label>Display Name</label>
                <input type="text" id="input-username" placeholder="How others see you">
            </div>

            <button id="mainBtn" onclick="handleAuth()">Continue</button>
        </div>
    </div>

    <div id="chat-container" class="card">
        <div id="messages"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="msg-input" placeholder="Message #global" style="margin-bottom: 0;">
            <button onclick="sendMessage()" style="width: 100px;">Send</button>
        </div>
    </div>

    <script>
        let currentMode = 'login';
        let jwtToken = null;
        let currentUser = null;
        let stompClient = null;

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('reg-only').style.display = (mode === 'reg') ? 'block' : 'none';
            document.getElementById('tab-login').className = (mode === 'login') ? 'tab active' : 'tab';
            document.getElementById('tab-reg').className = (mode === 'reg') ? 'tab active' : 'tab';
            document.getElementById('mainBtn').innerText = (mode === 'login') ? 'Login' : 'Create Account';
            hideError();
        }

        async function handleAuth() {
            const login = document.getElementById('input-login').value;
            const password = document.getElementById('input-password').value;
            
            // Client-side Password Confirmation Check
            if (currentMode === 'reg') {
                const confirm = document.getElementById('input-confirm').value;
                if (password !== confirm) {
                    showError("Passwords do not match!");
                    return;
                }
            }

            const url = (currentMode === 'login') ? '/api/auth/login' : '/api/auth/register';
            const payload = { login, password };
            
            if (currentMode === 'reg') {
                payload.email = document.getElementById('input-email').value;
                payload.userName = document.getElementById('input-username').value;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    showError(errorMsg);
                    return;
                }

                const data = await response.json();
                jwtToken = data.token;
                currentUser = data.accountDto.userDto;

                await loadHistory();
                connectWebSocket();
            } catch (err) {
                showError("Server unreachable. Is the backend running?");
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/messages?page=0&limit=50', {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                const messages = await response.json();
                const msgBox = document.getElementById('messages');
                msgBox.innerHTML = '';
                // Render from oldest to newest
                messages.reverse().forEach(msg => renderMessage(msg));
            } catch (err) {
                console.error("History load failed", err);
            }
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            const headers = { 'Authorization': `Bearer ${jwtToken}` };

            stompClient.connect(headers, () => {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';

                stompClient.subscribe('/topic/public', (payload) => {
                    renderMessage(JSON.parse(payload.body));
                });

                // JOIN notification
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    content: `${currentUser.name} joined the chat!`,
                    type: 'JOIN',
                    userDto: currentUser
                }));

            }, (err) => {
                showError("WebSocket connection failed.");
            });
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !stompClient) return;

            stompClient.send("/app/chat.send", {}, JSON.stringify({
                content: text,
                type: 'SEND',
                userDto: currentUser
            }));
            input.value = '';
        }

        function renderMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            
            if (msg.type === 'JOIN') {
                div.className = 'msg-join';
                div.innerText = msg.content;
            } else {
                div.className = 'msg';
                const time = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const name = msg.userDto?.name || 'System';
                
                div.innerHTML = `
                    <div><span class="username">${name}</span><span class="timestamp">${time}</span></div>
                    <div style="margin-top:4px;">${msg.content}</div>
                `;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showError(t) { const e = document.getElementById('auth-error'); e.innerText = t; e.style.display = 'block'; }
        function hideError() { document.getElementById('auth-error').style.display = 'none'; }
        
        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>