<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fakecord | Global Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #36393f; color: #dcddde; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #2f3136; padding: 32px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); width: 400px; }
        #chat-container { display: none; width: 900px; height: 85vh; flex-direction: column; }
        
        h2 { text-align: center; color: white; margin-top: 0; }
        label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: bold; color: #b9bbbe; text-transform: uppercase; }
        input { background: #202225; border: 1px solid #202225; color: white; padding: 10px; border-radius: 3px; width: 100%; box-sizing: border-box; margin-bottom: 20px; outline: none; transition: border 0.2s; }
        input:focus { border-color: #5865f2; }
        
        button { background: #5865f2; color: white; border: none; padding: 12px; border-radius: 3px; cursor: pointer; font-weight: 500; width: 100%; font-size: 1rem; }
        button:hover { background: #4752c4; }

        #messages { flex-grow: 1; overflow-y: auto; background: #36393f; padding: 20px; margin-bottom: 15px; border-radius: 4px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 15px; padding: 5px; border-radius: 4px; }
        .msg:hover { background: rgba(255,255,255,0.02); }
        .username { color: #fff; font-weight: 600; margin-right: 8px; }
        .timestamp { color: #72767d; font-size: 0.75rem; }
        
        .msg-join { color: #43b581; font-style: italic; text-align: center; font-size: 0.85rem; margin: 10px 0; }
        
        .error-box { color: #f04747; background: rgba(240, 71, 71, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; border: 1px solid #f04747; }
    </style>
</head>
<body>

    <div id="login-container" class="card">
        <h2>Fakecord Account</h2>
        <div id="login-error" class="error-box"></div>
        <input type="email" id="reg-email" placeholder="Email">
        <input type="text" id="reg-username" placeholder="Username">
        <input type="text" id="reg-login" placeholder="Login ID">
        <input type="password" id="reg-password" placeholder="Password">
        <button id="joinBtn">Continue</button>
    </div>

    <div id="chat-container" class="card">
        <div id="messages"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="content" placeholder="Message #global" style="margin-bottom: 0;">
            <button id="sendBtn" style="width: 100px;">Send</button>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentUser = null; 
        let jwtToken = null;

        async function handleRegister() {
            const payload = {
                email: document.getElementById('reg-email').value,
                userName: document.getElementById('reg-username').value,
                login: document.getElementById('reg-login').value,
                password: document.getElementById('reg-password').value
            };

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.text();
                    document.getElementById('login-error').innerText = error;
                    document.getElementById('login-error').style.display = 'block';
                    return;
                }

                const data = await response.json();
                jwtToken = data.token;
                currentUser = data.accountDto.userDto;
                
                await loadHistory();
                connectToWebSocket();

            } catch (err) {
                console.error("Login Error:", err);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/messages?page=0&limit=50', {
                    headers: { 'Authorization': 'Bearer ' + jwtToken }
                });
                const messages = await response.json();
                messages.reverse().forEach(msg => renderMessage(msg));
            } catch (err) {
                console.error("Failed to load history", err);
            }
        }

        function connectToWebSocket() {
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            const headers = { 'Authorization': 'Bearer ' + jwtToken };

            stompClient.connect(headers, () => {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                
                stompClient.subscribe('/topic/public', (payload) => {
                    renderMessage(JSON.parse(payload.body));
                });

                sendJoinMessage();

            }, (error) => {
                console.error("STOMP Error:", error);
            });
        }

        function sendJoinMessage() {
            const joinMsg = {
                content: `${currentUser.name} joined to chat`,
                type: 'JOIN',
                userDto: currentUser
            };
            stompClient.send("/app/chat.send", {}, JSON.stringify(joinMsg));
        }

        function sendMessage() {
            const input = document.getElementById('content');
            const text = input.value.trim();
            if (!text || !stompClient) return;

            const chatMessageDto = {
                content: text,
                type: 'SEND',
                userDto: currentUser
            };

            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessageDto));
            input.value = '';
        }

        function renderMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            
            if (msg.type === 'JOIN') {
                div.className = 'msg-join';
                div.innerText = msg.content;
            } else {
                div.className = 'msg';
                const sender = msg.userDto ? msg.userDto.name : 'System';
                const time = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                div.innerHTML = `
                    <div>
                        <span class="username">${sender}</span>
                        <span class="timestamp">${time}</span>
                    </div>
                    <div style="color: #dcddde; margin-top: 4px;">${msg.content}</div>
                `;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('joinBtn').onclick = handleRegister;
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('content').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>